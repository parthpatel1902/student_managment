<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <%- include('../partials/navbar.ejs') %>

    <div class="container">
        <div class="row">
            <div class="col-md-12 mt-3" id="resultTable">
            </div>
        </div>
    </div>
     <!-- The Modal -->
     <div class="modal" id="myModal">
        <div class="modal-dialog">
          <div class="modal-content">
  
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Update Student Name :- <span id="nameUpdate"></span></h4>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <!-- Modal body -->
            <div class="modal-body">
                <input type="hidden" id="id_update" value=""/>
                <div class="mb-3">
                  <label for="name" class="form-label">Name</label>
                  <input type="text" class="form-control" id="updatename" required>
                </div>
                <div class="mb-3">
                  <label for="email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="updateemail" required>
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Password</label>
                  <input type="text" class="form-control" id="updatepassword" required>
                </div>
                <button class="btn btn-primary" class="btn-close" onclick="handleUpdate(event)">Update</button>
            </div>
  
          </div>
        </div>
      </div>
</body>

<script>

        function deleteRecord(item){
          Swal.fire({
            title: `Do you want to delete ${item.name}'s name record?`,
            confirmButtonText: "Delete",
            showCancelButton: true,
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire("Deleted!", "", "success");
              const apiData = new FormData();
              apiData.append('id', item.id);
              fetch('/removestud', {
                  method: 'POST',
                  body: apiData,
              })
              .then(response => response.json())
              .then(resData => {
                  if(resData.success == true){
                    Swal.fire({
                      title: "success!",
                      text: "Student is Removed",
                      icon: "success"
                    }).then((data)=>{
                      if(data.isConfirmed){
                        location.replace("/view") 
                      }
                    })
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
              });
            } else if (result.isDenied) {
              Swal.fire("Not Deleted", "", "info");
            }
          });
          
        }
        
        displayRecord();
        function displayRecord(){
          fetch("/displaystud").then(response => response.json()).then((data) => {
              let output = "<table class='table table-dark'><thead><th>No.</th><th>Name</th><th>Email</th><th>Mobile</th><th>Bloodgroup</th><th>Gender</th><th>Birthdate</th><th>Height</th><th>Password</th><th>Update</th><th>Delete</th></thead><tbody>";
              let i=1;
              data.map((item)=>{
                  const updateData = {
                    id:item._id,
                    name:item.name,
                    email:item.email,
                    mobile:item.mobile,
                    bloodgroup:item.bloodgroup,
                    gender:item.gender,
                    bdate:item.bdate,
                    height:item.height,
                    password:item.password
                  }

                  const deleteData = {
                    id:item._id,
                    name:item.name
                  }
                  output +=`<tr><td>${i++}</td><td>${item.name}</td><td>${item.email}</td><td>${item.mobile}</td><td>${item.bloodgroup}</td><td>${item.gender}</td><td>${item.bdate}</td><td>${item.height}</td><td>${item.password}</td><td><button onclick='updateRecord(${JSON.stringify(updateData)})' class='btn btn-primary'  data-bs-toggle="modal" data-bs-target="#myModal">update</button></td><td><button class='btn btn-danger' onclick='deleteRecord(${JSON.stringify(deleteData)})'>Delete</button></td></tr>`;
              })
              output += "</tbody></table>";
              document.getElementById("resultTable").innerHTML = output;
          })
        }

        function updateRecord(data){
          document.getElementById('nameUpdate').innerText = data.name;
          document.getElementById('updatename').value = data.name;
          document.getElementById('updateemail').value = data.email;
          document.getElementById('updatepassword').value = data.password;
          document.getElementById('id_update').value = data.id;
        }


        function handleUpdate(event) {
          event.preventDefault();
          const name = document.getElementById('updatename').value;
          const email = document.getElementById('updateemail').value;
          const password = document.getElementById('updatepassword').value;
          const id = document.getElementById('id_update').value;

          const apiData = new FormData();
          apiData.append('id', id);
          apiData.append('name', name);
          apiData.append('email', email);
          apiData.append('password', password);

          fetch('/updatestud', {
              method: 'POST',
              body: apiData,
          })
          .then(response => response.json())
          .then(resData => {
              if(resData.success == true){
                window.location.reload();
              }
          })
          .catch(error => {
              console.error('Error:', error);
          });
        }

        
</script>
</html>